
<!DOCTYPE html>
<html lang="en">
<head>
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css' integrity='sha256-aNiC51TQHvkWrMMLceXgyYnGfXL0IwDeIhxveiXOKFM=' crossorigin='anonymous'>

    <link rel="stylesheet" type="text/css" href="https://www.ericlight.com/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://www.ericlight.com/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://www.ericlight.com/theme/font-awesome/css/font-awesome.min.css">


    <link href="https://www.ericlight.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Such geek. Wow. Atom">



  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />


<meta name="author" content="Eric Light" />
<meta name="description" content="Let's Encrypt's Certbot will generate an RSA key by default. But we want to step into the new and exciting world of elliptic curve cryptography! Unfortunately Certbot doesn't really roll that way, so there are a couple hoops to jump through first. A word of caution: this post has been written in retrospect, some time after I actually got ECDSA working. That means there are bound to be squiggly little steps that I've missed, and I certainly should have provided screenshots or snippets that I've ..." />
<meta name="keywords" content="Security">
<meta property="og:site_name" content="Such geek. Wow."/>
<meta property="og:title" content="Using ECDSA certificates with Let's Encrypt"/>
<meta property="og:description" content="Let's Encrypt's Certbot will generate an RSA key by default. But we want to step into the new and exciting world of elliptic curve cryptography! Unfortunately Certbot doesn't really roll that way, so there are a couple hoops to jump through first. A word of caution: this post has been written in retrospect, some time after I actually got ECDSA working. That means there are bound to be squiggly little steps that I've missed, and I certainly should have provided screenshots or snippets that I've ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://www.ericlight.com/articles/using-ecdsa-certificates-with-lets-encrypt.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-10-27 01:35:27.762098+13:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://www.ericlight.com/author/eric-light.html">
<meta property="article:section" content="Tech"/>
<meta property="article:tag" content="Security"/>
<meta property="og:image" content="">

  <title>Such geek. Wow. &ndash; Using ECDSA certificates with Let's Encrypt</title>
</head>
<body>
  <aside>
    <div>
      <a href="https://www.ericlight.com">
        <img src="https://www.ericlight.com/theme/img/profile.png" alt="Making things work" title="Making things work">
      </a>
      <h1><a href="https://www.ericlight.com">Making things work</a></h1>

<p>An eclectic collection of technical learnings and assorted challenges, for... reasons.</p>
      <nav>
        <ul class="list">
          <li><a href="https://www.ericlight.com/pages/about-me.html">About Me</a></li>

          <li><a href="http://python.org/" target="_blank">Python.org</a></li>
          <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-linkedin" href="https://linkedin.com/in/ericdlight" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/rhyven" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/rhyvenNZ" target="_blank"><i class="fa fa-twitter"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>

<article class="single">
  <header>
    <h1 id="using-ecdsa-certificates-with-lets-encrypt">Using ECDSA certificates with Let's Encrypt</h1>
    <p>
          Posted on Thu 27 October 2016 in <a href="https://www.ericlight.com/category/tech.html">Tech</a>


    </p>
  </header>
  <div>
    <p><a href="https://www.letsencrypt.org">Let's Encrypt</a>'s Certbot will generate an RSA key by default.  But we want to step into the new and exciting world of elliptic curve cryptography! Unfortunately Certbot doesn't really roll that way, so there are a couple hoops to jump through first.</p>
<p>A word of caution: this post has been written in retrospect, some time after I actually got ECDSA working.  That means there are bound to be squiggly little steps that I've missed, and I certainly should have provided screenshots or snippets that I've missed.  Sorry.</p>
<p>This post assumes you've already installed Certbot.  I had a working regular certificate from Certbot before I changed to ECDSA, so if you have problems following this from scratch, I do recommend trying that first.</p>
<p>For future reference, I'm running the latest certbot available in Debian unstable, which is version 0.8.1-3.</p>
<p>I got most of this information from <a href="https://scotthelme.co.uk/tag/lets-encrypt/">Scott Helme's website</a>, which has been awesome.</p>
<p>In brief:</p>
<p>1)  Generate yourself an ECDSA private key:</p>
<div class="highlight"><pre><span></span>openssl ecparam -genkey -name secp384r1 | openssl ec -out ec.key
</pre></div>


<p>You can change the curve that you use, if you feel a bit wiggly about the <a href="http://blog.cr.yp.to/20140323-ecdsa.html">controversy around the NSA &amp; NIST</a> degrading the quality of the curves.  I don't feel particularly wiggly about that, myself.</p>
<p>2)  Generate a Certificate Signing Request (CSR) with your shiny new key:</p>
<div class="highlight"><pre><span></span>openssl req -new -sha256 -key ec.key -nodes -out ec.csr -outform pem
</pre></div>


<p>That will give you ec.key (your private key), and ec.csr (your certificate signing request).  Time to get Let's Encrypt involved.</p>
<p>3)  Create your certificate:</p>
<div class="highlight"><pre><span></span>certbot certonly -w /var/www/html/ -d {your_domain} --email &quot;{your_email}&quot; --csr ./ec.csr --agree-tos
</pre></div>


<p>If everything goes perfectly, that should leave you with a new shiny set of certificates -- quite possibly named something clumsy like 0000-cert.pem and 0001-fullchain.pem, or similar.  Throw those into your nginx config and give it a test to see if it's working.</p>
<p>4)  Schedule your certificate renewals:</p>
<p>I had particular trouble with the renewal process of ECDSA certificates, because <code>certbot renew</code> isn't compatible with custom CSR's.  You need to run <code>certbot certonly</code> to pass the --csr argument, and then you need to deal with the output yourself.</p>
<p>Even more irksome, the certonly function will fail if you ask it to renew certificates which already exist:</p>
<div class="highlight"><pre><span></span>An unexpected error occurred:
OSError: [Errno 17] File exists: &#39;/etc/letsencrypt/live/{your_domain}/cert_ecdsa.pem&#39;
Please see the logfiles in /var/log/letsencrypt for more details.
</pre></div>


<p>There doesn't seem to be any way to tell certbot to overwrite the old certificates automatically, so I created a /etc/letsencrypt/temp folder, and wrote up a really yuck cron job for it.  If I were working on a production system I'd do something better, but this works for my lowly domain:</p>
<div class="highlight"><pre><span></span># Recreate certs under /etc/letsencrypt/temp
30 2 24 * * certbot certonly -w /var/www/html/ -d {your_domain} --email &quot;{your_email}&quot; --csr /path/to/your/ec.csr --agree-tos --non-interactive --webroot --cert-path /etc/letsencrypt/temp/cert_ecdsa.pem --fullchain-path /etc/letsencrypt/temp/fullchain_ecdsa.pem

# Backup current certs to home dir
31 2 24 * * mv /etc/letsencrypt/live/{your_domain}/cert_ecdsa.pem ~/certbackup/
31 2 24 * * mv /etc/letsencrypt/live/{your_domain}/fullchain_ecdsa.pem ~/certbackup/

# Move new certs to live folder
32 2 24 * * mv /etc/letsencrypt/temp/* /etc/letsencrypt/live/{your_domain}/

# Restart nginx
33 2 24 * * service nginx restart
</pre></div>


<p>And that's all!  It seems to be working so far, but I'm sure something is going to fail at some point -- maybe I'll hit my request limit, or the Let's Encrypt service will be down, and I'll lose my certs.  If it happens too often I'll come up with a nicer cronjob and update this post.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.ericlight.com/tag/security.html">Security</a>
    </p>
  </div>



</article>

    <footer>
<p>&copy; Eric Light </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Such geek. Wow. ",
  "url" : "https://www.ericlight.com",
  "image": "",
  "description": ""
}
</script>
</body>
</html>